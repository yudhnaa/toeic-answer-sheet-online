<!DOCTYPE html>
<html lang="vi">
	<head>
		<meta charset="UTF-8" />
		<title>TOEIC Answer Sheet</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
			}

			h1 {
				text-align: center;
			}

			.section-title {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-top: 30px;
			}

			.counter {
				font-weight: bold;
				font-size: 15px;
			}

			/* ANSWER SHEET */
			.answer-sheet {
				display: grid;
				grid-template-columns: repeat(4, 1fr);
				margin-top: 10px;
				border: 1px solid #999;
			}

			/* COLUMN */
			.column {
				padding: 8px 10px;
			}

			.column:not(:last-child) {
				border-right: 2px solid #999; /* đường kẻ chia cột */
			}

			/* QUESTION ROW */
			.question {
				display: flex;
				align-items: center;
				margin-bottom: 6px;
				font-size: 14px;
			}

			.q-number {
				width: 32px;
				font-weight: bold;
			}

			/* OPTIONS */
			.options {
				display: flex;
				gap: 10px;
			}

			/* RADIO TO */
			.options input[type="radio"] {
				transform: scale(1.4); /* làm nút to */
				cursor: pointer;
				margin-right: 2px;
			}

			.options label {
				display: flex;
				align-items: center;
				gap: 3px;
				cursor: pointer;
			}

			/* BUTTONS */
			.controls {
				margin-top: 30px;
				display: flex;
				gap: 12px;
			}

			button {
				padding: 8px 14px;
				font-size: 14px;
				cursor: pointer;
				border: 1px solid #ccc;
				background-color: #f9f9f9;
				border-radius: 3px;
			}

			button:hover {
				background-color: #e9e9e9;
			}
			/* RESPONSIVE */
			@media (max-width: 1024px) {
				.answer-sheet {
					grid-template-columns: repeat(2, 1fr);
				}

				.column {
					border-right: none;
				}

				.column:nth-child(odd) {
					border-right: 2px solid #999;
				}
			}

			@media (max-width: 600px) {
				.answer-sheet {
					grid-template-columns: 1fr;
				}

				.column {
					border-right: none !important;
					border-bottom: 2px solid #999;
				}
			}

			/* MARK BUTTONS */
			.mark {
				margin-left: auto;
				display: flex;
				gap: 4px;
			}

			.mark button {
				font-size: 12px;
				padding: 2px 8px;
				cursor: pointer;
			}

			.question.right {
				background-color: #e6f7e6;
			}

			.question.wrong {
				background-color: #fbe6e6;
			}

			/* ANSWER DISPLAY */
			.answer-display {
				width: 28px;
				text-align: center;
				font-weight: bold;
				border: 1px solid #000000;
				border-radius: 3px;
				margin-left: 8px;
				display: none;
				color: #333;
				font-size: 13px;
				padding: 0px;
				background-color: #f9f9f9;
			}

			.answer-display.show {
				display: inline-block;
			}

			.separate.show {
				display: inline !important;
			}

			/* TOAST NOTIFICATION */
			#toast {
				position: fixed;
				bottom: 30px;
				left: 50%;
				transform: translateX(-50%);
				background-color: #333;
				color: white;
				padding: 12px 24px;
				border-radius: 6px;
				font-size: 14px;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
				opacity: 0;
				visibility: hidden;
				transition: opacity 0.3s, visibility 0.3s;
				z-index: 1000;
			}

			#toast.show {
				opacity: 1;
				visibility: visible;
			}

			#toast.success {
				background-color: #4caf50;
			}

			#toast.error {
				background-color: #f44336;
			}
		</style>
	</head>

	<body>
		<h1>TOEIC Answer Sheet</h1>

		<div id="toast"></div>

		<!-- LISTENING -->
		<div class="section-title">
			<h2>Listening (1–100)</h2>
			<div>
				<button onclick="toggleSectionAnswers('listening')">ANS</button>
				<span class="counter" id="listeningCount">0 / 100</span>
			</div>
		</div>
		<div id="listening" class="answer-sheet"></div>

		<!-- READING -->
		<div class="section-title">
			<h2>Reading (101–200)</h2>
			<div>
				<button onclick="toggleSectionAnswers('reading')">ANS</button>
				<span class="counter" id="readingCount">0 / 100</span>
			</div>
		</div>
		<div id="reading" class="answer-sheet"></div>

		<div class="controls">
			<button onclick="document.getElementById('importFile').click()">
				Import Result
			</button>
			<input
				type="file"
				id="importFile"
				accept=".json"
				onchange="importJSON(event)"
				style="display: none"
			/>
			<button onclick="document.getElementById('loadAnswerFile').click()">
				Load Answer Key
			</button>
			<input
				type="file"
				id="loadAnswerFile"
				accept=".json"
				onchange="loadAnswersFromJSON(event)"
				style="display: none"
			/>
			<button onclick="exportJSON()">Export Result</button>
			<button onclick="resetAll()">Reset</button>
		</div>

		<script>
			const answers = {
				listening: {},
				reading: {},
			};

			function showToast(message, type = 'success') {
				const toast = document.getElementById('toast');
				toast.textContent = message;
				toast.className = 'show ' + type;

				setTimeout(() => {
					toast.classList.remove('show');
				}, 3000);
			}

			function createSection(containerId, start, end, sectionKey) {
				const container = document.getElementById(containerId);
				const total = end - start + 1;
				const perColumn = 25;

				for (let c = 0; c < 4; c++) {
					const col = document.createElement("div");
					col.className = "column";

					for (let i = 0; i < perColumn; i++) {
						const qNum = start + c * perColumn + i;
						if (qNum > end) break;

						const qDiv = document.createElement("div");
						qDiv.className = "question";
						qDiv.dataset.question = qNum;

						const num = document.createElement("div");
						num.className = "q-number";
						num.textContent = qNum;

						const opts = document.createElement("div");
						opts.className = "options";

						["A", "B", "C", "D"].forEach((letter) => {
							const label = document.createElement("label");
							const input = document.createElement("input");

							input.type = "radio";
							input.name = "q" + qNum;
							input.value = letter;
							input.onchange = () => {
								const current = answers[sectionKey][qNum] || {
									mark: null,
									right_answer: null,
								};

								answers[sectionKey][qNum] = {
									answer: letter,
									mark: current.mark,
									right_answer: current.right_answer,
								};

								updateCount();
							};

							label.appendChild(input);
							label.append(letter);
							opts.appendChild(label);
						});

						const answerDisplay = document.createElement("input");
						answerDisplay.type = "text";
						answerDisplay.className = "answer-display";
						answerDisplay.dataset.question = qNum;
						answerDisplay.maxLength = 1;
						answerDisplay.readOnly = true;
						const mark = document.createElement("div");
						mark.className = "mark";

						const markBtn = document.createElement("button");
						markBtn.textContent = "MARK";
						markBtn.onclick = () => toggleMark(sectionKey, qNum, qDiv);

						const separate = document.createElement("span");
						separate.className = "separate";
						separate.textContent = "|->";
						separate.style.marginLeft = "6px";
						separate.style.marginRight = "6px";
						separate.style.display = "none";

						mark.appendChild(markBtn);
						qDiv.appendChild(num);
						qDiv.appendChild(opts);
						qDiv.appendChild(separate);
						qDiv.appendChild(answerDisplay);
						qDiv.appendChild(mark);

						col.appendChild(qDiv);
					}

					container.appendChild(col);
				}
			}

			function updateCount() {
				const countAnswered = (section) =>
					Object.values(answers[section]).filter((item) => item.answer !== null)
						.length;

				document.getElementById("listeningCount").textContent =
					countAnswered("listening") + " / 100";

				document.getElementById("readingCount").textContent =
					countAnswered("reading") + " / 100";
			}

			function exportJSON() {
				const data = JSON.stringify(answers, null, 2);
				const blob = new Blob([data], { type: "application/json" });
				const url = URL.createObjectURL(blob);

				const a = document.createElement("a");
				a.href = url;
				a.download = "toeic_answers.json";
				a.click();
				URL.revokeObjectURL(url);
			}

			function importJSON(event) {
				const file = event.target.files[0];
				if (!file) return;

				const reader = new FileReader();
				reader.onload = (e) => {
					const data = JSON.parse(e.target.result);

					resetAll(false);

					["listening", "reading"].forEach((section) => {
						if (!data[section]) return;
						for (const q in data[section]) {
							const item = data[section][q];

							if (item.answer) {
								const input = document.querySelector(
									`input[name="q${q}"][value="${item.answer}"]`
								);
								if (input) input.checked = true;
							}

							answers[section][q] = {
								answer: item.answer || null,
								mark: item.mark || null,
								right_answer: item.right_answer || null,
							};

							const qDiv = document.querySelector(`[data-question="${q}"]`);
							if (qDiv) {
								qDiv.classList.remove("right", "wrong");
								if (item.mark) qDiv.classList.add(item.mark);
							}

							const displayElement = document.querySelector(
								`.answer-display[data-question="${q}"]`
							);
							if (displayElement && item.right_answer) {
								displayElement.value = item.right_answer;
							}
						}
					});

					updateCount();
				};
				reader.readAsText(file);
			}

			function resetAll(update = true) {
				document
					.querySelectorAll("input[type=radio]")
					.forEach((i) => (i.checked = false));
				document.querySelectorAll(".answer-display").forEach((el) => {
					el.value = "";
					el.classList.remove("show");
				});
				document.querySelectorAll(".separate").forEach((el) => {
					el.classList.remove("show");
				});
				document.querySelectorAll(".question").forEach((el) => {
					el.classList.remove("right", "wrong");
				});
				answers.listening = {};
				answers.reading = {};
				if (update) updateCount();
			}

			createSection("listening", 1, 100, "listening");
			createSection("reading", 101, 200, "reading");
			updateCount();

			function toggleSectionAnswers(section) {
				const sectionContainer = document.getElementById(section);
				if (!sectionContainer) return;

				const answerDisplays =
					sectionContainer.querySelectorAll(".answer-display");
				const separates = sectionContainer.querySelectorAll(".separate");
				const isCurrentlyShowing =
					answerDisplays[0]?.classList.contains("show");

				answerDisplays.forEach((display) => {
					if (isCurrentlyShowing) {
						display.classList.remove("show");
					} else {
						display.classList.add("show");
					}
				});

				separates.forEach((separate) => {
					if (isCurrentlyShowing) {
						separate.classList.remove("show");
					} else {
						separate.classList.add("show");
					}
				});

				// Auto mark answers if showing
				if (!isCurrentlyShowing) {
					const start = section === "listening" ? 1 : 101;
					const end = section === "listening" ? 100 : 200;

					for (let qNum = start; qNum <= end; qNum++) {
						const answerData = answers[section][qNum];
						if (!answerData || !answerData.right_answer) continue;

						const userAnswer = answerData.answer;
						const rightAnswer = answerData.right_answer;

						const qDiv = document.querySelector(
							`.question[data-question="${qNum}"]`
						);
						if (!qDiv) continue;

						// Auto mark based on comparison
						if (userAnswer) {
							if (userAnswer === rightAnswer) {
								qDiv.classList.remove("wrong");
								qDiv.classList.add("right");
								answerData.mark = "right";
							} else {
								qDiv.classList.remove("right");
								qDiv.classList.add("wrong");
								answerData.mark = "wrong";
							}
						}
					}
				}
			}

			function loadAnswersFromJSON(event) {
				const file = event.target.files[0];
				if (!file) return;

				const reader = new FileReader();
				reader.onload = (e) => {
					try {
						const data = JSON.parse(e.target.result);

						// Process listening section (1-100)
						if (data.listening) {
							for (const q in data.listening) {
								const qNum = parseInt(q);
								const item = data.listening[q];

								// Extract answer - handle multiple formats
								let answer = null;
								if (typeof item === "string") {
									answer = item;
								} else if (typeof item === "object") {
									// Prioritize right_answer, then answer
									answer = item.right_answer || item.answer;
								}

								// Only set if answer is valid (A, B, C, or D)
								if (
									answer &&
									["A", "B", "C", "D"].includes(answer.toUpperCase())
								) {
									answer = answer.toUpperCase();

									if (!answers.listening[qNum]) {
										answers.listening[qNum] = {
											answer: null,
											mark: null,
											right_answer: null,
										};
									}
									answers.listening[qNum].right_answer = answer;

									const displayElement = document.querySelector(
										`.answer-display[data-question="${qNum}"]`
									);
									if (displayElement) {
										displayElement.value = answer;
									}
								}
							}
						}

						// Process reading section (101-200)
						if (data.reading) {
							for (const q in data.reading) {
								const qNum = parseInt(q);
								const item = data.reading[q];

								// Extract answer - handle multiple formats
								let answer = null;
								if (typeof item === "string") {
									answer = item;
								} else if (typeof item === "object") {
									// Prioritize right_answer, then answer
									answer = item.right_answer || item.answer;
								}

								// Only set if answer is valid (A, B, C, or D)
								if (
									answer &&
									["A", "B", "C", "D"].includes(answer.toUpperCase())
								) {
									answer = answer.toUpperCase();

									if (!answers.reading[qNum]) {
										answers.reading[qNum] = {
											answer: null,
											mark: null,
											right_answer: null,
										};
									}
									answers.reading[qNum].right_answer = answer;

									const displayElement = document.querySelector(
										`.answer-display[data-question="${qNum}"]`
									);
									if (displayElement) {
										displayElement.value = answer;
									}
								}
							}
						}

					showToast('Answer key loaded successfully!', 'success');
				} catch (error) {
					showToast('Error: ' + error.message, 'error');
				}
			};
			reader.readAsText(file);

			// Reset file input
			event.target.value = "";
		}

		function toggleMark(section, qNum, element) {
			const current = answers[section][qNum] || {
				answer: null,
				mark: null,
				right_answer: null,
			};

			let nextMark;
			if (current.mark === null) {
				nextMark = "right";
			} else if (current.mark === "right") {
				nextMark = "wrong";
			} else {
				nextMark = null;
			}

			answers[section][qNum] = {
				answer: current.answer,
				mark: nextMark,
				right_answer: current.right_answer,
			};

			element.classList.remove("right", "wrong");
			if (nextMark) element.classList.add(nextMark);
		}
	</script>
	</body>
</html>
